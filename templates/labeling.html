{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block navigation %}
<!-- Hide navigation for labeling interface -->
{% endblock %}

{% block content %}
<div class="h-screen flex flex-col">
    <!-- Header -->
    <div class="bg-gray-800 shadow-sm border-b border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between">
            <div>
                <div class="flex items-center space-x-2">
                    <h1 id="project-name-display" class="text-2xl font-bold text-white cursor-pointer hover:text-blue-300 transition-colors"
                        data-project-id="{{ project.id }}">{{ project.name }}</h1>
                    <button id="edit-project-name" class="text-gray-400 hover:text-blue-400 transition-colors" title="Edit project name">
                        <i class="fas fa-edit text-sm"></i>
                    </button>
                </div>
                <input id="project-name-input" type="text" value="{{ project.name }}"
                       class="text-2xl font-bold text-white bg-transparent border-b-2 border-blue-500 focus:outline-none focus:border-blue-400 hidden"
                       data-project-id="{{ project.id }}">
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-sm text-gray-400">
                    <span id="current-image">1</span> of <span id="total-images">{{ images|length }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu for Annotations -->
    <div id="annotation-context-menu" class="fixed bg-gray-800 border border-gray-600 rounded-lg shadow-lg z-50 hidden">
        <div class="py-1">
            <button id="edit-annotation" class="w-full px-4 py-2 text-left text-sm text-blue-400 hover:bg-gray-700 flex items-center">
                <i class="fas fa-edit mr-2"></i>Edit Category
            </button>
            <button id="delete-annotation" class="w-full px-4 py-2 text-left text-sm text-red-400 hover:bg-gray-700 flex items-center">
                <i class="fas fa-trash mr-2"></i>Delete Annotation
            </button>
        </div>
    </div>

    <div class="flex-1 flex">
        <!-- Sidebar -->
        <div class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col">
            <!-- Label Categories -->
            <div class="p-4 border-b border-gray-700">
                <h3 class="text-lg font-semibold text-white mb-3">Label Categories</h3>
                <div class="space-y-2">
                    {% for category in label_categories %}
                    <div class="label-category flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors"
                         data-category-id="{{ category.id }}"
                         data-color="{{ category.color }}">
                        <div class="w-4 h-4 rounded-full mr-3" style="background-color: {{ category.color }}"></div>
                        <span class="text-sm font-medium text-gray-200">{{ category.name }}</span>
                    </div>
                    {% endfor %}
                </div>
                <button id="add-category" class="mt-3 w-full text-sm text-blue-400 hover:text-blue-300 font-medium">
                    <i class="fas fa-plus mr-1"></i>Add Category
                </button>
            </div>

            <!-- Image Upload -->
            <div class="p-4 border-b border-gray-700">
                <h3 class="text-lg font-semibold text-white mb-3">Upload Images</h3>
                <div class="space-y-3">
                    <div class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center hover:border-blue-400 transition-colors">
                        <input type="file" id="image-upload" multiple accept="image/*,.tiff,.tif" class="hidden">
                        <label for="image-upload" class="cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-300">Click to upload images</p>
                            <p class="text-xs text-gray-500">PNG, JPG, JPEG, GIF, TIFF supported</p>
                        </label>
                    </div>
                    <button id="upload-images" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-upload mr-2"></i>Upload Selected Images
                    </button>
                </div>
            </div>

            <!-- Image Thumbnails -->
            <div class="flex-1 p-4 overflow-y-auto">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-white">Images</h3>
                    <span class="text-sm text-gray-400" id="image-count">{{ images|length }} images</span>
                </div>
                <div class="grid grid-cols-2 gap-2" id="image-grid">
                    {% for image in images %}
                    <div class="image-thumbnail cursor-pointer border-2 border-transparent hover:border-blue-500 rounded-lg overflow-hidden transition-colors relative group"
                         data-image-id="{{ image.id }}">
                        <img src="/{{ image.thumbnail_path }}"
                             alt="{{ image.original_filename }}"
                             class="w-full h-20 object-cover">
                        <div class="p-1 text-xs text-gray-300 truncate">{{ image.original_filename }}</div>
                        <!-- Delete button for thumbnail -->
                        <button class="thumbnail-delete-btn absolute top-1 right-1 w-6 h-6 bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center text-xs hover:bg-red-700"
                                data-image-id="{{ image.id }}"
                                data-image-name="{{ image.original_filename }}"
                                title="Delete image">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Main Canvas Area -->
        <div class="flex-1 flex flex-col">
            <!-- Toolbar -->
            <div class="bg-gray-800 border-b border-gray-700 px-4 py-2">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <button id="select-tool" class="tool-btn active px-3 py-1 rounded text-sm font-medium bg-blue-600 text-white">
                            <i class="fas fa-mouse-pointer mr-1"></i>Select
                        </button>
                        <button id="bbox-tool" class="tool-btn px-3 py-1 rounded text-sm font-medium text-gray-300 hover:bg-gray-700">
                            <i class="fas fa-square mr-1"></i>Bounding Box
                        </button>
                        <button id="polygon-tool" class="tool-btn px-3 py-1 rounded text-sm font-medium text-gray-300 hover:bg-gray-700">
                            <i class="fas fa-draw-polygon mr-1"></i>Polygon
                        </button>
                        <button id="point-tool" class="tool-btn px-3 py-1 rounded text-sm font-medium text-gray-300 hover:bg-gray-700">
                            <i class="fas fa-circle mr-1"></i>Point
                        </button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="zoom-in" class="px-2 py-1 rounded text-sm text-gray-300 hover:bg-gray-700">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button id="zoom-out" class="px-2 py-1 rounded text-sm text-gray-300 hover:bg-gray-700">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button id="fit-to-screen" class="px-2 py-1 rounded text-sm text-gray-300 hover:bg-gray-700">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                        <div class="w-px h-6 bg-gray-600"></div>
                        <button id="close-image" class="px-3 py-1 rounded text-sm text-gray-300 hover:bg-red-600 hover:text-white transition-colors opacity-50 cursor-not-allowed" disabled>
                            <i class="fas fa-times mr-1"></i>Close Image
                        </button>
                        <button id="delete-image" class="px-3 py-1 rounded text-sm text-gray-300 hover:bg-red-700 hover:text-white transition-colors opacity-50 cursor-not-allowed" disabled>
                            <i class="fas fa-trash mr-1"></i>Delete Image
                        </button>
                    </div>
                </div>
            </div>

            <!-- Image Canvas -->
            <div class="flex-1 relative overflow-hidden bg-gray-900">
                <div id="canvas-container" class="absolute inset-0 flex items-center justify-center">
                    <div id="image-container" class="relative">
                        <img id="main-image"
                             src=""
                             alt="Image to label"
                             class="max-w-full max-h-full object-contain hidden">
                        <canvas id="annotation-canvas"
                                class="absolute inset-0 cursor-crosshair"></canvas>
                        <!-- No image placeholder -->
                        <div id="no-image-placeholder" class="flex flex-col items-center justify-center h-64 text-gray-500">
                            <i class="fas fa-image text-6xl mb-4"></i>
                            <p class="text-lg font-medium">No image selected</p>
                            <p class="text-sm">Upload images to get started with labeling</p>
                        </div>
                    </div>
                </div>

                <!-- Loading overlay -->
                <div id="loading-overlay" class="absolute inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
                    <div class="text-center">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-gray-300">Loading image...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div id="add-category-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-96 border border-gray-700">
        <h3 class="text-lg font-semibold text-white mb-4">Add Label Category</h3>
        <form id="category-form">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">Category Name</label>
                <input type="text" id="category-name" required
                       class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">Color</label>
                <div class="flex items-center space-x-2">
                    <input type="color" id="category-color" value="#3B82F6"
                           class="w-12 h-8 border border-gray-600 rounded bg-gray-700">
                    <input type="text" id="category-color-text" value="#3B82F6"
                           class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancel-category"
                        class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600">
                    Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                    Add Category
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Image Confirmation Modal -->
<div id="delete-image-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-96 border border-gray-700">
        <h3 class="text-lg font-semibold text-white mb-4">Delete Image</h3>
        <p class="text-gray-300 mb-6">Are you sure you want to delete this image? This action cannot be undone and will also delete all associated annotations.</p>
        <div class="flex justify-end space-x-3">
            <button type="button" id="cancel-delete"
                    class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600">
                Cancel
            </button>
            <button type="button" id="confirm-delete"
                    class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">
                <i class="fas fa-trash mr-1"></i>Delete Image
            </button>
        </div>
    </div>
</div>

<!-- Thumbnail Delete Confirmation Modal -->
<div id="thumbnail-delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-96 border border-gray-700">
        <h3 class="text-lg font-semibold text-white mb-4">Delete Image</h3>
        <p class="text-gray-300 mb-2">Are you sure you want to delete this image?</p>
        <p class="text-sm text-gray-400 mb-6" id="thumbnail-delete-image-name"></p>
        <p class="text-gray-300 mb-6">This action cannot be undone and will also delete all associated annotations.</p>
        <div class="flex justify-end space-x-3">
            <button type="button" id="cancel-thumbnail-delete"
                    class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600">
                Cancel
            </button>
            <button type="button" id="confirm-thumbnail-delete"
                    class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">
                <i class="fas fa-trash mr-1"></i>Delete Image
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Data labeling interface JavaScript
let currentImageIndex = 0;
let currentTool = 'select';
let selectedCategory = null;
let annotations = [];
let isDrawing = false;
let startX, startY;
let selectedAnnotation = null;

const images = {{ images | tojson }};
const labelCategories = {{ label_categories | tojson }};

// Initialize the interface
document.addEventListener('DOMContentLoaded', function() {
    if (images.length > 0) {
        loadImage(0);
    } else {
        showNoImagePlaceholder();
    }

    setupEventListeners();
    loadAnnotations();
});

function setupEventListeners() {
    // Tool selection
    document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tool-btn').forEach(b => {
                b.classList.remove('active', 'bg-blue-600', 'text-white', 'bg-blue-100', 'text-blue-700');
                b.classList.add('text-gray-300', 'hover:bg-gray-700');
            });
            this.classList.add('active', 'bg-blue-600', 'text-white');
            this.classList.remove('text-gray-300', 'hover:bg-gray-700');
            currentTool = this.id.replace('-tool', '');
        });
    });

    // Label category selection
    document.querySelectorAll('.label-category').forEach(cat => {
        cat.addEventListener('click', function() {
            // Remove selection from all categories
            document.querySelectorAll('.label-category').forEach(c => c.classList.remove('bg-blue-600'));
            // Add selection to clicked category
            this.classList.add('bg-blue-600');
            // Set selected category
            selectedCategory = parseInt(this.dataset.categoryId);
        });
    });

    // Image thumbnails
    document.querySelectorAll('.image-thumbnail').forEach((thumb, index) => {
        thumb.addEventListener('click', function(e) {
            // Don't load image if delete button was clicked
            if (e.target.closest('.thumbnail-delete-btn')) {
                return;
            }
            loadImage(index);
        });
    });

    // Thumbnail delete buttons
    document.querySelectorAll('.thumbnail-delete-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent thumbnail click
            const imageId = parseInt(this.dataset.imageId);
            const imageName = this.dataset.imageName;
            showThumbnailDeleteConfirmation(imageId, imageName);
        });
    });

    // Image upload
    const imageUpload = document.getElementById('image-upload');
    const uploadButton = document.getElementById('upload-images');

    imageUpload.addEventListener('change', function() {
        const files = this.files;
        if (files.length > 0) {
            uploadButton.disabled = false;
            uploadButton.textContent = `Upload ${files.length} Image${files.length > 1 ? 's' : ''}`;
        } else {
            uploadButton.disabled = true;
            uploadButton.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload Selected Images';
        }
    });

    uploadButton.addEventListener('click', uploadImages);

    // Canvas events
    const canvas = document.getElementById('annotation-canvas');
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);


    // Close image button
    document.getElementById('close-image').addEventListener('click', closeImage);

    // Delete image button
    document.getElementById('delete-image').addEventListener('click', showDeleteConfirmation);

    // Delete confirmation modal
    document.getElementById('cancel-delete').addEventListener('click', hideDeleteConfirmation);
    document.getElementById('confirm-delete').addEventListener('click', deleteImage);

    // Thumbnail delete confirmation modal
    document.getElementById('cancel-thumbnail-delete').addEventListener('click', hideThumbnailDeleteConfirmation);
    document.getElementById('confirm-thumbnail-delete').addEventListener('click', deleteThumbnailImage);

    // Project name editing
    document.getElementById('edit-project-name').addEventListener('click', startEditingProjectName);
    document.getElementById('project-name-display').addEventListener('click', startEditingProjectName);
    document.getElementById('project-name-input').addEventListener('blur', saveProjectName);
    document.getElementById('project-name-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            saveProjectName();
        } else if (e.key === 'Escape') {
            cancelEditingProjectName();
        }
    });

    // Add category modal
    document.getElementById('add-category').addEventListener('click', () => {
        document.getElementById('add-category-modal').classList.remove('hidden');
        document.getElementById('add-category-modal').classList.add('flex');
    });

    document.getElementById('cancel-category').addEventListener('click', () => {
        document.getElementById('add-category-modal').classList.add('hidden');
        document.getElementById('add-category-modal').classList.remove('flex');
    });

    document.getElementById('category-form').addEventListener('submit', addCategory);

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Escape key to close current image
        if (e.key === 'Escape') {
            const mainImage = document.getElementById('main-image');
            if (!mainImage.classList.contains('hidden')) {
                closeImage();
            }
        }
        // Delete key to delete selected annotation
        if (e.key === 'Delete' && selectedAnnotation) {
            deleteSelectedAnnotation();
        }
    });

    // Context menu event listeners
    document.getElementById('edit-annotation').addEventListener('click', editAnnotation);
    document.getElementById('delete-annotation').addEventListener('click', deleteSelectedAnnotation);

    // Hide context menu when clicking elsewhere
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#annotation-context-menu') && !e.target.closest('#annotation-canvas')) {
            hideAnnotationContextMenu();
        }
    });
}

function loadImage(index) {
    if (index < 0 || index >= images.length) {
        // No images available, show placeholder
        showNoImagePlaceholder();
        return;
    }

    // Deselect any selected annotation when switching images
    deselectAnnotation();

    currentImageIndex = index;
    const image = images[index];

    document.getElementById('loading-overlay').classList.remove('hidden');
    document.getElementById('no-image-placeholder').classList.add('hidden');

    const img = document.getElementById('main-image');

    // Add timeout to prevent infinite loading
    const loadingTimeout = setTimeout(() => {
        document.getElementById('loading-overlay').classList.add('hidden');
        showNotification('Image loading timed out', 'error');
    }, 10000); // 10 second timeout

    // Add error handling for failed image loads
    img.onerror = function() {
        clearTimeout(loadingTimeout);
        document.getElementById('loading-overlay').classList.add('hidden');
        showNotification('Failed to load image', 'error');
        console.error('Failed to load image:', image.file_path);
    };

    img.onload = function() {
        clearTimeout(loadingTimeout);
        document.getElementById('loading-overlay').classList.add('hidden');
        img.classList.remove('hidden');
        setupCanvas();
        loadImageAnnotations(image.id);

        // Enable close and delete buttons when image is loaded
        document.getElementById('close-image').disabled = false;
        document.getElementById('close-image').classList.remove('opacity-50', 'cursor-not-allowed');
        document.getElementById('delete-image').disabled = false;
        document.getElementById('delete-image').classList.remove('opacity-50', 'cursor-not-allowed');
    };

    img.src = `/${image.file_path}`;
    document.getElementById('current-image').textContent = index + 1;

    // Update thumbnail selection
    document.querySelectorAll('.image-thumbnail').forEach((thumb, i) => {
        thumb.classList.toggle('border-blue-500', i === index);
    });
}

function showNoImagePlaceholder() {
    document.getElementById('main-image').classList.add('hidden');
    document.getElementById('no-image-placeholder').classList.remove('hidden');
    document.getElementById('current-image').textContent = '0';

    // Disable close and delete buttons when no image is loaded
    document.getElementById('close-image').disabled = true;
    document.getElementById('close-image').classList.add('opacity-50', 'cursor-not-allowed');
    document.getElementById('delete-image').disabled = true;
    document.getElementById('delete-image').classList.add('opacity-50', 'cursor-not-allowed');
}

function closeImage() {
    // Hide the current image and show the placeholder
    document.getElementById('main-image').classList.add('hidden');
    document.getElementById('no-image-placeholder').classList.remove('hidden');
    document.getElementById('current-image').textContent = '0';

    // Clear the canvas
    const canvas = document.getElementById('annotation-canvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Clear current annotations
    annotations = [];

    // Reset thumbnail selection
    document.querySelectorAll('.image-thumbnail').forEach(thumb => {
        thumb.classList.remove('border-blue-500');
    });

    // Show notification
    showNotification('Image closed', 'info');
}

function showDeleteConfirmation() {
    document.getElementById('delete-image-modal').classList.remove('hidden');
    document.getElementById('delete-image-modal').classList.add('flex');
}

function hideDeleteConfirmation() {
    document.getElementById('delete-image-modal').classList.add('hidden');
    document.getElementById('delete-image-modal').classList.remove('flex');
}

function deleteImage() {
    if (images.length === 0 || currentImageIndex < 0 || currentImageIndex >= images.length) {
        showNotification('No image to delete', 'error');
        return;
    }

    const imageToDelete = images[currentImageIndex];

    // Show loading state
    document.getElementById('confirm-delete').disabled = true;
    document.getElementById('confirm-delete').innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Deleting...';

    // Delete the image via API
    fetch(`/api/images/${imageToDelete.id}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Remove image from local array
        images.splice(currentImageIndex, 1);

        // Update UI
        updateImageGrid();

        // If we deleted the last image, show placeholder
        if (images.length === 0) {
            showNoImagePlaceholder();
        } else {
            // Adjust current index if needed
            if (currentImageIndex >= images.length) {
                currentImageIndex = images.length - 1;
            }
            // Load the next/previous image
            loadImage(currentImageIndex);
        }

        // Hide modal
        hideDeleteConfirmation();

        // Show success notification
        showNotification('Image deleted successfully', 'success');
    })
    .catch(error => {
        console.error('Error deleting image:', error);
        showNotification('Error deleting image', 'error');

        // Reset button state
        document.getElementById('confirm-delete').disabled = false;
        document.getElementById('confirm-delete').innerHTML = '<i class="fas fa-trash mr-1"></i>Delete Image';
    });
}

function showThumbnailDeleteConfirmation(imageId, imageName) {
    document.getElementById('thumbnail-delete-image-name').textContent = imageName;
    document.getElementById('thumbnail-delete-modal').classList.remove('hidden');
    document.getElementById('thumbnail-delete-modal').classList.add('flex');
}

function hideThumbnailDeleteConfirmation() {
    document.getElementById('thumbnail-delete-modal').classList.add('hidden');
    document.getElementById('thumbnail-delete-modal').classList.remove('flex');
}

function deleteThumbnailImage() {
    // Get the image ID from the modal context
    const imageName = document.getElementById('thumbnail-delete-image-name').textContent;
    const image = images.find(img => img.original_filename === imageName);
    if (!image) {
        showNotification('Image not found', 'error');
        hideThumbnailDeleteConfirmation();
        return;
    }
    const imageId = image.id;

    // Show loading state
    document.getElementById('confirm-thumbnail-delete').disabled = true;
    document.getElementById('confirm-thumbnail-delete').innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Deleting...';

    // Delete the image via API
    fetch(`/api/images/${imageId}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Find and remove image from local array
        const imageIndex = images.findIndex(img => img.id === imageId);
        if (imageIndex !== -1) {
            images.splice(imageIndex, 1);
        }

        // Update UI
        updateImageGrid();

        // If we deleted the currently loaded image, show placeholder or load next
        if (currentImageIndex === imageIndex) {
            if (images.length === 0) {
                showNoImagePlaceholder();
            } else {
                // Adjust current index if needed
                if (currentImageIndex >= images.length) {
                    currentImageIndex = images.length - 1;
                }
                // Load the next/previous image
                loadImage(currentImageIndex);
            }
        } else if (imageIndex < currentImageIndex) {
            // Adjust current index if we deleted an image before the current one
            currentImageIndex--;
        }

        // Hide modal
        hideThumbnailDeleteConfirmation();

        // Show success notification
        showNotification('Image deleted successfully', 'success');
    })
    .catch(error => {
        console.error('Error deleting image:', error);
        showNotification('Error deleting image', 'error');

        // Reset button state
        document.getElementById('confirm-thumbnail-delete').disabled = false;
        document.getElementById('confirm-thumbnail-delete').innerHTML = '<i class="fas fa-trash mr-1"></i>Delete Image';
    });
}

function updateImageCounters() {
    const imageCount = document.getElementById('image-count');
    const totalImages = document.getElementById('total-images');
    const currentImage = document.getElementById('current-image');

    // Update counts
    const countText = `${images.length} image${images.length !== 1 ? 's' : ''}`;
    imageCount.textContent = countText;
    totalImages.textContent = images.length;

    // Update current image counter
    if (images.length === 0) {
        currentImage.textContent = '0';
    } else if (currentImageIndex >= 0 && currentImageIndex < images.length) {
        currentImage.textContent = currentImageIndex + 1;
    } else {
        currentImage.textContent = '0';
    }
}

function updateImageGrid() {
    const imageGrid = document.getElementById('image-grid');

    // Update counters
    updateImageCounters();

    // Rebuild grid
    imageGrid.innerHTML = '';
    images.forEach((image, index) => {
        const thumbDiv = document.createElement('div');
        thumbDiv.className = 'image-thumbnail cursor-pointer border-2 border-transparent hover:border-blue-500 rounded-lg overflow-hidden transition-colors relative group';
        thumbDiv.setAttribute('data-image-id', image.id);

        thumbDiv.innerHTML = `
            <img src="/${image.thumbnail_path}"
                 alt="${image.original_filename}"
                 class="w-full h-20 object-cover">
            <div class="p-1 text-xs text-gray-300 truncate">${image.original_filename}</div>
            <!-- Delete button for thumbnail -->
            <button class="thumbnail-delete-btn absolute top-1 right-1 w-6 h-6 bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center text-xs hover:bg-red-700"
                    data-image-id="${image.id}"
                    data-image-name="${image.original_filename}"
                    title="Delete image">
                <i class="fas fa-times"></i>
            </button>
        `;

        // Add click event for thumbnail
        thumbDiv.addEventListener('click', function(e) {
            // Don't load image if delete button was clicked
            if (e.target.closest('.thumbnail-delete-btn')) {
                return;
            }
            loadImage(index);
        });

        // Add click event for delete button
        const deleteBtn = thumbDiv.querySelector('.thumbnail-delete-btn');
        deleteBtn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent thumbnail click
            const imageId = parseInt(this.dataset.imageId);
            const imageName = this.dataset.imageName;
            showThumbnailDeleteConfirmation(imageId, imageName);
        });

        imageGrid.appendChild(thumbDiv);
    });
}

function startEditingProjectName() {
    const display = document.getElementById('project-name-display');
    const input = document.getElementById('project-name-input');
    const editBtn = document.getElementById('edit-project-name');

    // Hide display and show input
    display.classList.add('hidden');
    input.classList.remove('hidden');
    editBtn.classList.add('hidden');

    // Focus and select text
    input.focus();
    input.select();
}

function cancelEditingProjectName() {
    const display = document.getElementById('project-name-display');
    const input = document.getElementById('project-name-input');
    const editBtn = document.getElementById('edit-project-name');

    // Reset input value to original
    input.value = display.textContent;

    // Hide input and show display
    input.classList.add('hidden');
    display.classList.remove('hidden');
    editBtn.classList.remove('hidden');
}

function saveProjectName() {
    const display = document.getElementById('project-name-display');
    const input = document.getElementById('project-name-input');
    const editBtn = document.getElementById('edit-project-name');
    const projectId = input.dataset.projectId;
    const newName = input.value.trim();

    if (!newName) {
        showNotification('Project name cannot be empty', 'error');
        cancelEditingProjectName();
        return;
    }

    if (newName === display.textContent) {
        // No change, just cancel editing
        cancelEditingProjectName();
        return;
    }

    // Show loading state
    input.disabled = true;
    input.value = 'Saving...';

    // Update project name via API
    fetch(`/api/projects/${projectId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: newName
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Update display
        display.textContent = newName;

        // Hide input and show display
        input.classList.add('hidden');
        display.classList.remove('hidden');
        editBtn.classList.remove('hidden');

        // Reset input
        input.disabled = false;
        input.value = newName;

        // Show success notification
        showNotification('Project name updated successfully', 'success');
    })
    .catch(error => {
        console.error('Error updating project name:', error);
        showNotification('Error updating project name', 'error');

        // Reset input
        input.disabled = false;
        input.value = display.textContent;
        cancelEditingProjectName();
    });
}

function setupCanvas() {
    const canvas = document.getElementById('annotation-canvas');
    const img = document.getElementById('main-image');
    const container = document.getElementById('image-container');

    // Only setup canvas if image is visible
    if (img.classList.contains('hidden')) {
        return;
    }

    // Set canvas size to match image
    canvas.width = img.offsetWidth;
    canvas.height = img.offsetHeight;

    // Clear canvas
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function startDrawing(e) {
    const rect = e.target.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    if (currentTool === 'select') {
        // Handle annotation selection
        const clickedAnnotation = getAnnotationAtPoint(x, y);
        if (clickedAnnotation) {
            selectAnnotation(clickedAnnotation);
        } else {
            deselectAnnotation();
        }
        return;
    }

    if (!selectedCategory) return;

    isDrawing = true;
    startX = x;
    startY = y;
}

function draw(e) {
    if (!isDrawing || currentTool === 'select') return;

    const canvas = document.getElementById('annotation-canvas');
    const ctx = canvas.getContext('2d');
    const rect = e.target.getBoundingClientRect();
    const currentX = e.clientX - rect.left;
    const currentY = e.clientY - rect.top;

    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Draw existing annotations
    drawExistingAnnotations();

    // Draw current annotation
    if (currentTool === 'bbox') {
        ctx.strokeStyle = getCategoryColor(selectedCategory);
        ctx.lineWidth = 2;
        ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
    } else if (currentTool === 'point') {
        ctx.fillStyle = getCategoryColor(selectedCategory);
        ctx.beginPath();
        ctx.arc(startX, startY, 5, 0, 2 * Math.PI);
        ctx.fill();
    }
}

function stopDrawing(e) {
    if (!isDrawing || currentTool === 'select') return;

    isDrawing = false;
    const rect = e.target.getBoundingClientRect();
    const endX = e.clientX - rect.left;
    const endY = e.clientY - rect.top;

    // Create annotation
    const annotation = {
        id: Date.now(),
        image_id: images[currentImageIndex].id,
        label_category_id: selectedCategory,
        tool: currentTool,
        coordinates: {
            startX, startY, endX, endY
        },
        created_at: new Date().toISOString()
    };

    annotations.push(annotation);
    drawExistingAnnotations();

    // Automatically save the annotation to the database
    saveAnnotationToDatabase(annotation);
}

function drawExistingAnnotations() {
    const canvas = document.getElementById('annotation-canvas');
    const ctx = canvas.getContext('2d');

    annotations.forEach(annotation => {
        if (annotation.image_id !== images[currentImageIndex].id) return;

        const isSelected = selectedAnnotation && selectedAnnotation.id === annotation.id;

        // Draw annotation
        ctx.strokeStyle = getCategoryColor(annotation.label_category_id);
        ctx.fillStyle = getCategoryColor(annotation.label_category_id);
        ctx.lineWidth = isSelected ? 3 : 2;

        if (annotation.tool === 'bbox') {
            const { startX, startY, endX, endY } = annotation.coordinates;
            ctx.strokeRect(startX, startY, endX - startX, endY - startY);

            // Draw selection handles if selected
            if (isSelected) {
                drawSelectionHandles(ctx, startX, startY, endX, endY);
            }
        } else if (annotation.tool === 'point') {
            const { startX, startY } = annotation.coordinates;
            ctx.beginPath();
            ctx.arc(startX, startY, isSelected ? 7 : 5, 0, 2 * Math.PI);
            ctx.fill();

            // Draw selection ring if selected
            if (isSelected) {
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(startX, startY, 10, 0, 2 * Math.PI);
                ctx.stroke();
            }
        }
    });
}

function drawSelectionHandles(ctx, startX, startY, endX, endY) {
    const handleSize = 6;
    const handles = [
        { x: startX, y: startY }, // top-left
        { x: (startX + endX) / 2, y: startY }, // top-center
        { x: endX, y: startY }, // top-right
        { x: endX, y: (startY + endY) / 2 }, // right-center
        { x: endX, y: endY }, // bottom-right
        { x: (startX + endX) / 2, y: endY }, // bottom-center
        { x: startX, y: endY }, // bottom-left
        { x: startX, y: (startY + endY) / 2 } // left-center
    ];

    ctx.fillStyle = '#ffffff';
    ctx.strokeStyle = '#007bff';
    ctx.lineWidth = 2;

    handles.forEach(handle => {
        ctx.fillRect(handle.x - handleSize/2, handle.y - handleSize/2, handleSize, handleSize);
        ctx.strokeRect(handle.x - handleSize/2, handle.y - handleSize/2, handleSize, handleSize);
    });
}

function getCategoryColor(categoryId) {
    const category = labelCategories.find(cat => cat.id === categoryId);
    return category ? category.color : '#3B82F6';
}

function loadImageAnnotations(imageId) {
    // Load existing annotations for this image
    fetch(`/api/annotations/${imageId}`)
        .then(response => response.json())
        .then(data => {
            // Convert database annotations to frontend format
            const loadedAnnotations = (data.annotations || []).map(dbAnnotation => ({
                id: dbAnnotation.id,
                image_id: dbAnnotation.image_id,
                label_category_id: dbAnnotation.label_category_id,
                tool: 'bbox', // Default tool, could be stored in annotation_data
                coordinates: dbAnnotation.annotation_data,
                created_at: dbAnnotation.created_at
            }));

            // Replace annotations for this image
            annotations = annotations.filter(ann => ann.image_id !== imageId);
            annotations = annotations.concat(loadedAnnotations);

            drawExistingAnnotations();
        })
        .catch(error => {
            console.error('Error loading annotations:', error);
        });
}

function saveAnnotationToDatabase(annotation) {
    // Save a single annotation to the database
    fetch('/api/annotations', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            image_id: annotation.image_id,
            label_category_id: annotation.label_category_id,
            annotation_data: annotation.coordinates,
            confidence: 1.0
        })
    })
    .then(response => response.json())
    .then(data => {
        // Update the annotation with the database ID
        annotation.id = data.annotation_id;
        console.log('Annotation saved to database:', data);
    })
    .catch(error => {
        console.error('Error saving annotation:', error);
        showNotification('Error saving annotation', 'error');
    });
}


function uploadImages() {
    const fileInput = document.getElementById('image-upload');
    const files = fileInput.files;

    if (files.length === 0) {
        showNotification('Please select images to upload', 'error');
        return;
    }

    const uploadButton = document.getElementById('upload-images');
    uploadButton.disabled = true;
    uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';

    const formData = new FormData();
    Array.from(files).forEach(file => {
        formData.append('file', file);
    });
    formData.append('dataset_id', {{ dataset.id }});

    fetch('/api/images/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        showNotification(`${files.length} image(s) uploaded successfully!`, 'success');
        // Reset upload form
        fileInput.value = '';
        uploadButton.disabled = true;
        uploadButton.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload Selected Images';
        // Reload page to show new images
        setTimeout(() => {
            location.reload();
        }, 1500); // Small delay to show notification
    })
    .catch(error => {
        console.error('Error uploading images:', error);
        showNotification('Error uploading images', 'error');
        uploadButton.disabled = false;
        uploadButton.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload Selected Images';
    });
}

function addCategory(e) {
    e.preventDefault();

    const name = document.getElementById('category-name').value;
    const color = document.getElementById('category-color').value;

    fetch('/api/label-categories', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            name: name,
            color: color,
            project_id: {{ project.id }}
        })
    })
    .then(response => response.json())
    .then(data => {
        showNotification('Category added successfully!', 'success');
        location.reload(); // Refresh to show new category
    })
    .catch(error => {
        console.error('Error adding category:', error);
        showNotification('Error adding category', 'error');
    });
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;

    // Set colors based on type
    if (type === 'success') {
        notification.classList.add('bg-green-500', 'text-white');
    } else if (type === 'error') {
        notification.classList.add('bg-red-500', 'text-white');
    } else {
        notification.classList.add('bg-blue-500', 'text-white');
    }

    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation' : 'info'}-circle mr-2"></i>
            <span>${message}</span>
        </div>
    `;

    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);

    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// Annotation selection and editing functions
function getAnnotationAtPoint(x, y) {
    const currentImageId = images[currentImageIndex]?.id;
    if (!currentImageId) return null;

    const imageAnnotations = annotations.filter(ann => ann.image_id === currentImageId);

    // Check annotations in reverse order (topmost first)
    for (let i = imageAnnotations.length - 1; i >= 0; i--) {
        const annotation = imageAnnotations[i];
        if (isPointInAnnotation(x, y, annotation)) {
            return annotation;
        }
    }
    return null;
}

function selectAnnotation(annotation) {
    selectedAnnotation = annotation;
    drawExistingAnnotations();
    showAnnotationContextMenu();
}

function deselectAnnotation() {
    selectedAnnotation = null;
    drawExistingAnnotations();
    hideAnnotationContextMenu();
}

function showAnnotationContextMenu() {
    const contextMenu = document.getElementById('annotation-context-menu');
    if (contextMenu && selectedAnnotation) {
        // Position the context menu near the selected annotation
        const canvas = document.getElementById('annotation-canvas');
        const rect = canvas.getBoundingClientRect();

        // Calculate position based on annotation center
        const coords = selectedAnnotation.coordinates;
        const centerX = (coords.startX + coords.endX) / 2;
        const centerY = (coords.startY + coords.endY) / 2;

        contextMenu.style.left = (rect.left + centerX) + 'px';
        contextMenu.style.top = (rect.top + centerY) + 'px';
        contextMenu.classList.remove('hidden');
    }
}

function hideAnnotationContextMenu() {
    const contextMenu = document.getElementById('annotation-context-menu');
    if (contextMenu) {
        contextMenu.classList.add('hidden');
    }
}

function editAnnotation() {
    if (!selectedAnnotation) return;

    // For now, just show a simple prompt for editing category
    const newCategoryName = prompt('Edit annotation category:',
        labelCategories.find(cat => cat.id === selectedAnnotation.label_category_id)?.name || '');

    if (newCategoryName && newCategoryName.trim()) {
        const newCategory = labelCategories.find(cat => cat.name.toLowerCase() === newCategoryName.toLowerCase());
        if (newCategory) {
            selectedAnnotation.label_category_id = newCategory.id;
            drawExistingAnnotations();
            showNotification('Annotation updated!', 'success');
        } else {
            showNotification('Category not found!', 'error');
        }
    }
}

function deleteSelectedAnnotation() {
    if (!selectedAnnotation) return;

    if (confirm('Are you sure you want to delete this annotation?')) {
        // Remove from local array
        const index = annotations.findIndex(ann => ann.id === selectedAnnotation.id);
        if (index !== -1) {
            annotations.splice(index, 1);
        }

        // Delete from database if it has a database ID
        if (selectedAnnotation.id && typeof selectedAnnotation.id === 'number' && selectedAnnotation.id < 1000000000000) {
            fetch(`/api/annotations/${selectedAnnotation.id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                console.log('Annotation deleted from database:', data);
            })
            .catch(error => {
                console.error('Error deleting annotation from database:', error);
            });
        }

        deselectAnnotation();
        drawExistingAnnotations();
        showNotification('Annotation deleted!', 'success');
    }
}
</script>
{% endblock %}
